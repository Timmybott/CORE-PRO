<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBS Source Display</title>
    <style>
        body { background: transparent; margin: 0; padding: 0; overflow: hidden; width: 100vw; height: 100vh; color: white; font-family: 'Plus Jakarta Sans', sans-serif; }
        .canvas { position: absolute; inset: 0; }
        .source-item { position: absolute; box-sizing: border-box; display: flex; align-items: center; justify-content: center; overflow: hidden; pointer-events: none; transition: background-color 0.2s, border-radius 0.2s; }
        .text-layer { width: 100%; text-align: center; white-space: pre-wrap; line-height: 1.2; padding: 0 10px; }
        iframe, img, video { width: 100%; height: 100%; border: none; object-fit: cover; background: transparent; }
        #debug-status { position: fixed; bottom: 5px; right: 5px; font-size: 8px; color: rgba(255,255,255,0.05); }
    </style>
</head>
<body>
    <div id="overlay-container" class="canvas"></div>
    <div id="debug-status">Warten...</div>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCtCIVlpeHxk58T0jocsAbz4sdZTvPKzys",
            authDomain: "new-obs-data.firebaseapp.com",
            projectId: "new-obs-data",
            storageBucket: "new-obs-data.firebasestorage.app",
            messagingSenderId: "552069224960",
            appId: "1:552069224960:web:85dda7a0201682c96156e5",
            measurementId: "G-C2M3ZEYXRT"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'obs-pro-v1';

        const urlParams = new URLSearchParams(window.location.search);
        const streamerId = urlParams.get('streamer');
        const container = document.getElementById('overlay-container');
        const debug = document.getElementById('debug-status');

        let activeSources = [];

        async function init() {
            await auth.signInAnonymously();
            if (!streamerId) {
                debug.innerText = "Keine Streamer-ID in URL";
                return;
            }
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('streamers').doc(streamerId).onSnapshot((snap) => {
                if (snap.exists) {
                    debug.innerText = "Verbunden: " + streamerId;
                    render(snap.data());
                } else {
                    debug.innerText = "ID nicht gefunden";
                }
            });
        }

        function render(data) {
            const activeScene = data.scenes.find(s => s.id === data.activeScene);
            if (!activeScene) return;
            
            container.innerHTML = '';
            activeSources = activeScene.sources.filter(s => s.visible !== false);
            
            activeSources.sort((a, b) => a.z - b.z).forEach(src => {
                const el = document.createElement('div');
                el.id = "el-" + src.id;
                el.className = 'source-item';
                
                const finalBg = (src.bgEnabled === false) ? 'transparent' : (src.bgColor || 'rgba(30,30,30,0.8)');

                el.style.cssText = `
                    left: ${src.x}%; top: ${src.y}%; width: ${src.w}%; height: ${src.h}%;
                    background-color: ${finalBg}; 
                    color: ${src.color || '#ffffff'}; 
                    border-radius: ${src.rounded || 0}px;
                    opacity: ${src.opacity}; z-index: ${src.z}; 
                    font-size: ${src.fontSize}px; font-weight: 700;
                    padding: 0;
                `;

                if (src.type === 'image') {
    el.innerHTML = `<img src="${src.content}" onerror="this.style.display='none'">`;
} else if (src.type === 'video') {
    // Hier wird der Iframe Code direkt eingesetzt
    el.innerHTML = src.content || ''; 
    // Sicherstellen, dass das Video den Container fÃ¼llt
    const ifr = el.querySelector('iframe');
    if(ifr) {
        ifr.style.width = "100%";
        ifr.style.height = "100%";
        ifr.style.border = "none";
    }
} else if (src.type === 'web') {
    // (Bestehende Web Logik)
    const iframe = document.createElement('iframe');
    iframe.src = src.content;
    
    // Zoom / Skalierung Logik
    const scale = src.scale || 1;
    if (scale !== 1) {
        iframe.style.width = `${100 / scale}%`;
        iframe.style.height = `${100 / scale}%`;
        iframe.style.transform = `scale(${scale})`;
        iframe.style.transformOrigin = 'center center';
    }

    const permissions = "autoplay; fullscreen; microphone; camera; encrypted-media";
    iframe.allow = permissions;
    iframe.setAttribute("allow", permissions);
    iframe.setAttribute("allowfullscreen", "");
    iframe.setAttribute("allowtransparency", "true");
    iframe.setAttribute("sandbox", "allow-same-origin allow-scripts allow-pointer-lock allow-popups allow-forms allow-presentation");
    el.appendChild(iframe);
} else if (src.type === 'timer') {
                    const timerDiv = document.createElement('div');
                    timerDiv.id = "timer-val-" + src.id;
                    el.appendChild(timerDiv);
                } else {
                    const text = document.createElement('div');
                    text.className = 'text-layer';
                    text.innerText = src.content || '';
                    el.appendChild(text);
                }
                container.appendChild(el);
            });
            updateTimers();
        }

        function updateTimers() {
            activeSources.forEach(src => {
                if (src.type === 'timer') {
                    const el = document.getElementById("timer-val-" + src.id);
                    if (!el) return;
                    
                    let timeLeft = parseInt(src.content) || 0;
                    if (src.isRunning && src.lastStarted) {
                        const elapsed = Math.floor((Date.now() - src.lastStarted) / 1000);
                        timeLeft = Math.max(0, timeLeft - elapsed);
                    }

                    const m = Math.floor(timeLeft / 60);
                    const s = timeLeft % 60;
                    el.innerText = `${m}:${s.toString().padStart(2, '0')}`;
                }
            });
        }

        setInterval(updateTimers, 1000);
        init();
    </script>
</body>
</html>